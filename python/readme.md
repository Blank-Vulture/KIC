# プログラミング基礎Python - 最終課題

## 概要
授業`プログラミング基礎Python`の最終課題は、Python ファイルの静的解析とレポート生成を行うツールです。 プログラム名は`verify.py` になります。 解析結果は標準出力に表示され、必要に応じてHTML 形式のレポートとして出力されます。

## ディレクトリ構造
特定のディレクトリを指定することでツールを実行可能です。ですが、以下のディレクトリ構造に限り引数なしで全ての課題ファイルを一括解析できます。
<pre>
.
├── verify.py                # 最終課題のメインスクリプト
├── create_kadai_py.sh       # 課題ファイル生成用スクリプト
├── environment.yml          # Conda環境の設定ファイル
├── pyFile_zip.sh            # PythonファイルをZIPにまとめるスクリプト
├── pyproject.toml           # 解析ツールの標準設定ファイル
├── submission               # 提出用ZIPファイル
│   ├── week1-kadai.zip
│   └── …
├── week1                    # 週ごとの課題フォルダ
│   ├── week1-kadai1.py
│   └── …
├── week2
│   ├── week2-kadai1.py
│   └── …
├── week3
│   ├── learning_python.txt
│   ├── week3-kadai1.py
│   └── …
├── week4
│   ├── week4-kadai1.py
│   └── …
├── week5
│   ├── week5-kadai1.py
│   └── …
└── AnalyticsReport          # 解析レポートの出力先
    ├── report.html          # 解析結果のHTMLレポート
    ├── report.json          # 解析結果のJSONファイル
    └── report_chart.png     # エラー、警告、提案の比率を示すチャート
</pre>

## セットアップ
このプロジェクトは Anaconda 環境で動作します。以下の手順に従ってセットアップしてください。

1. **Conda 環境の作成**:
   `environment.yml` を使用して必要なパッケージをインストールします。Windowsの場合はclone or リポジトリのダウンロード後にenvironment.ymlのprefixを修正する必要があるかもしれません。
   ```bash
   conda env create -f environment.yml
   ```
2. **Conda 環境の有効化**(environment.ymlのprefixを修正しなかった場合):
   ```bash
    conda activate kisoron
   ```

## 使用方法
### 基本的な使い方
```bash
python verify.py
```

### オプション
```bash
$ python verify.py -h
usage: verify.py [-h] [--save-report] [--load-report] [--strict] [directory]

File analysis and reporting tool

positional arguments:
  directory      Directory to analyze

options:
  -h, --help     show this help message and exit
  --save-report  Save analysis report to report.json
  --load-report  Load analysis from report.json and generate HTML report
  --strict       Run analysis in strict mode
```

### サンプル
以下は実行例です。それぞれのオプションは組み合わせることが可能です。
> [!WARNING]
> `--save-report`と `--load-report` オプションの同時使用はテストしていません。

-  `week`で始まる全てのディレクトリを解析し、結果を標準出力に表示
    ```bash
    python verify.py
    ```

-  `week`で始まる全てのディレクトリを解析し、結果をHTMLレポートとして保存
    ```bash
    python verify.py --save-report
    ```

- 保存された解析結果を読み込み、HTMLレポートを生成
    ```bash
    python verify.py --load-report
    ```

- 厳密モードで解析
    ```bash
    python verify.py --strict
    ```
- 特定のディレクトリを指定して厳格モードで解析
    ```bash
    python verify.py week1 --strict
    ```


## 動機
私たちが日々書くコードは、単なる課題をこなすためのもの、動作すれば良いというものではありません。
それは自分の創造性の結晶であり、未来への投資です。
しかし、私は自分の書くコードに対して時折不安を感じていました。
バグやエラーが潜むそのコードが、本当にチームやプロジェクトの役に立っているのか。長期的に持続可能なのか。
そんな不安が頭を離れず、コードの品質を向上させるための方法を模索していました。

セキュアコーディングから始まり、言語の開発母体のガイドラインで推奨されている書き方などのコーディング規約は、コードの品質を向上させるための重要な要素です。
しかし、コーディング規約を常に意識して書くことは難しく、また、既存のコードに対しても適用することは容易ではありません。
そこで、私はPythonの静的解析ツールを使用して、コードの品質を自動的に評価するツールを作成することにしました。

## 仕組み
このツールには以下の技術が主軸となっています。

| 技術 | 説明                                                |
|:--:|---------------------------------------------------|
| black | Pythonのコードフォーマッター。PEP8に準拠したコードに既存のコードを修正する。       |
| pylint | Pythonコードの静的解析ツール。エラー検出、コーディング規約の確認、コードの品質向上を支援する。 |
| mypy | Pythonの型チェッカー。コード中の型の不整合を検出し、潜在的なバグを防ぐ。           |
| ruff | 高速なPythonコードの静的解析ツール。複数の解析を統合し、効率的にコードの品質をチェックする。 |
| Jinja2 | テンプレートエンジン。HTMLレポートの生成に使用され、解析結果を視覚的に表現する。        |
| matplotlib | Pythonのデータ可視化ライブラリ。エラー、警告、提案の比率をグラフとして表示するために使用。  |

### 動作の流れ

1. **ファイル収集**: 
   - 指定されたディレクトリ内のPythonファイルを再帰的に探索し、すべての`.py`ファイルを収集します。特定のディレクトリが指定されない場合は、`week`で始まる全てのディレクトリを対象とします。

2. **静的解析の実行**:
   - 収集したPythonファイルに対して、`pylint`、`mypy`、および`ruff`を使用して静的解析を行います。
   - 各ツールはエラー、警告、改善提案を検出し、その結果はデータ構造として保持されます。

3. **レポートの生成**:
   - 解析結果は`Jinja2`テンプレートを使用してHTML形式のレポートにまとめられます。HTMLレポートは`AnalyticsReport`ディレクトリに出力され、エラーや警告が視覚的に確認できるようになります。

4. **グラフの作成**:
   - 解析結果のエラー、警告、提案の比率を`matplotlib`を用いてグラフ化します。このグラフはHTMLレポートに埋め込まれ、解析の概要を視覚的に把握するのに役立ちます。

5. **レポートの保存**:
   - 解析結果はhtmlファイルの他に、`report.json`として保存されるため、他のツールに組み込む際にhtmlファイルへの解析を必要としません。

6. **ユーザーフィードバック**:
   - コマンドライン上でリアルタイムに解析の進行状況が表示されます。成功したファイル、失敗したファイルが簡潔に表示されます。HTMLレポートではより詳細なエラーが確認可能です。

## エラーレポートの読み方

`verify.py` による解析結果は、HTML形式のレポートとして出力されます。このレポートには、各ファイルの解析結果がまとめられており、エラーや警告、提案などが視覚的に確認できるようになっています。以下に、エラーレポートの各セクションの読み方を解説します。
> [!NOTE]
> ここにおけるエラーは、重大なものから警告や推奨を含みます。

### 1. レポートの概要セクション
レポートの最初のセクションでは、以下の情報が表示されます。
- **Total Files**: 解析対象となったPythonファイルの総数。
- **Success**: エラーや警告なしに解析が成功したファイルの数。
- **Fail**: エラーや警告が検出されたファイルの数。
- **Process Time**: 解析にかかった総時間。

このセクションは全体の進捗を把握するために有用です。

### 2. エラー、警告、提案の比率グラフ
次に表示されるのは、エラー、警告、提案の比率を示すグラフです。このグラフは、各カテゴリの発生数を視覚的に比較するためのもので、コードの品質を一目で把握するのに役立ちます。
- **Errors (赤)**: エラーが発生したファイルの数。
- **Warnings (オレンジ)**: 潜在的な問題や推奨される改善点。
- **Suggestions (緑)**: コーディングスタイルの改善や最適化の提案。

### 3. ファイルごとの結果
各ファイルの解析結果は、個別のカードとして表示されます。それぞれのカードには以下の情報が含まれます。

#### 3.1 ファイル名
- カードのヘッダー部分には、解析対象のファイル名が表示されます。これにより、どのファイルがどのような結果になったかがすぐにわかります。

#### 3.2 PyLint の結果
基本的な分析は全てRuffに任せているため、PyLintがエラーを検出しているということは、コードを見直す必要がある可能性が高いです。

#### 3.3 Ruff の結果
- **Ruff Errors**: 静的解析ツールRuffによって検出されたエラーのリストです。
- **Ruff Warnings**: コードの改善が必要とされる部分が警告として表示されます。
- **Ruff Suggestions**: 最適化やスタイル改善のための提案が示されます。

#### 3.4 Mypy の結果
mypyでエラーが検出された場合、基本的には実行時にエラーが出たり想定した挙動をしない可能性のあるコードになります。
- **Mypy Errors**: 型チェックによって検出されたエラーがリスト化されます。これには、期待される型と実際の型が一致しない場合のエラーなどが含まれます。
- **Mypy Warnings**: 型に関連する警告が表示されます。これにより、型の安全性が向上します。

### 4. 詳細の確認と対応
訂正提案は参考程度にしてください。特にstrictモードの場合は全ての提案を満たすことが難しいかもしれません。
- **エラーの詳細確認**: 各エラーや警告は具体的な行番号とともに表示されるため、修正が必要な部分を特定しやすくなっています。
- **推奨される修正**: 具体的な修正方法が提案されることもあり、コードの品質向上に直接的に役立ちます。